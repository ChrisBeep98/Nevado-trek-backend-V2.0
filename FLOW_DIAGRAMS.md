# System Flows & Sequence Diagrams

**Version**: 1.0  
**Last Updated**: November 25, 2025  
**Purpose**: Visual documentation of data flows and interactions

---

## ğŸ“Š TABLA DE CONTENIDOS

1. [Authentication Flow](#authentication-flow)
2. [Booking Creation Flow](#booking-creation)
3. [Transfer Flow](#transfer-flow)
4. [Cancel Flow](#cancellation-flow)
5. [Data Sync Patterns](#data-sync)

---

## ğŸ” AUTHENTICATION FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER   â”‚                    â”‚   Frontend   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                â”‚
     â”‚  1. Navigate to URL            â”‚
     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   â”‚
     â”‚                                â”‚
     â”‚                          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
     â”‚                          â”‚ Check      â”‚
     â”‚                          â”‚ localStorageâ”‚
     â”‚                          â”‚ for        â”‚
     â”‚                          â”‚ adminKey   â”‚
     â”‚                          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                â”‚
     â”‚                         No key â”‚ Key exists
     â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                    â”‚                      â”‚
     â”‚             â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
     â”‚             â”‚  Redirect  â”‚       â”‚  Redirect to â”‚
     â”‚             â”‚  to /login â”‚       â”‚  Dashboard   â”‚
     â”‚             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                    â”‚                     â”‚
     â”‚  2. Shows Login    â”‚                     â”‚
     â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
     â”‚                                          â”‚
     â”‚  3. Enters admin key                     â”‚
     â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>                       â”‚
     â”‚                   â”‚                      â”‚
     â”‚            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”               â”‚
     â”‚            â”‚  Validate   â”‚               â”‚
     â”‚            â”‚  (client)   â”‚               â”‚
     â”‚            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
     â”‚                   â”‚                      â”‚
     â”‚            Valid  â”‚  Invalid             â”‚
     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”               â”‚
     â”‚     â”‚                    â”‚               â”‚
     â”‚  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”          â”‚
     â”‚  â”‚ Save to     â”‚    â”‚ Show   â”‚          â”‚
     â”‚  â”‚ localStorageâ”‚    â”‚ Error  â”‚          â”‚
     â”‚  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚     â”‚                                    â”‚
     â”‚     â”‚  4. Set auth state                 â”‚
     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                          â”‚
     â”‚  5. Dashboard loads                      â”‚
     â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                          â”‚
     
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  Future API Calls                        â”‚
     â”‚                                          â”‚
     â”‚  axios.interceptor adds:                 â”‚
     â”‚  X-Admin-Secret-Key: {adminKey}          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ BOOKING CREATION FLOW (Join Existing Departure)

```
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚    â”‚ Frontend â”‚    â”‚ Service â”‚    â”‚  Backend â”‚    â”‚   DB     â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 1. Click    â”‚               â”‚              â”‚               â”‚
   â”‚ "Add Booking"â”‚              â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 2. Open modal â”‚              â”‚               â”‚
   â”‚             â”‚ with departureId            â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 3. Fetch departure          â”‚               â”‚
   â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚ GET /departures/:id          â”‚
   â”‚             â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>               â”‚
   â”‚             â”‚               â”‚              â”‚  Query        â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚  Departure    â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚  Departure   â”‚               â”‚
   â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 4. Display  â”‚               â”‚              â”‚               â”‚
   â”‚ form with   â”‚               â”‚              â”‚               â”‚
   â”‚ departure   â”‚               â”‚              â”‚               â”‚
   â”‚ info        â”‚               â”‚              â”‚               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 5. Fill     â”‚               â”‚              â”‚               â”‚
   â”‚ customer    â”‚               â”‚              â”‚               â”‚
   â”‚ + pax       â”‚               â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 6. Submit   â”‚               â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 7. Validate   â”‚              â”‚               â”‚
   â”‚             â”‚ capacity      â”‚              â”‚               â”‚
   â”‚             â”‚ (client)      â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ currentPax:6  â”‚              â”‚               â”‚
   â”‚             â”‚ + pax:2 = 8   â”‚              â”‚               â”‚
   â”‚             â”‚ â‰¤ maxPax:8 âœ… â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 8. Call join  â”‚              â”‚               â”‚
   â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚ POST /bookings/join          â”‚
   â”‚             â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ 9. Validate   â”‚
   â”‚             â”‚               â”‚              â”‚ capacity      â”‚
   â”‚             â”‚               â”‚              â”‚ (server)      â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ 10. Get       â”‚
   â”‚             â”‚               â”‚              â”‚ pricing       â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚  Tour pricing â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ 11. Create    â”‚
   â”‚             â”‚               â”‚              â”‚ booking       â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚  Save         â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ 12. Update    â”‚
   â”‚             â”‚               â”‚              â”‚ currentPax    â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚  Update dep   â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚  Booking (200)               â”‚
   â”‚             â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ Success       â”‚              â”‚               â”‚
   â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 13. Invalidate queries       â”‚               â”‚
   â”‚             â”‚ ['bookings']  â”‚              â”‚               â”‚
   â”‚             â”‚ ['departures']â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 14. Auto      â”‚              â”‚               â”‚
   â”‚             â”‚ re-fetch      â”‚              â”‚               â”‚
   â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚               â”‚
   â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 15. Show    â”‚               â”‚              â”‚               â”‚
   â”‚ toast +     â”‚               â”‚              â”‚               â”‚
   â”‚ updated UI  â”‚               â”‚              â”‚               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
```

---

## ğŸ”„ TRANSFER FLOW (Private â†’ Join Public)

```
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚    â”‚ Frontend â”‚    â”‚ Service â”‚    â”‚  Backend â”‚    â”‚   DB     â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 1. Open     â”‚               â”‚              â”‚               â”‚
   â”‚ Transfer tabâ”‚               â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 2. Query available            â”‚               â”‚
   â”‚             â”‚ public departures             â”‚               â”‚
   â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚               â”‚
   â”‚             â”‚               â”‚ GET /departures              â”‚
   â”‚             â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>               â”‚
   â”‚             â”‚               â”‚              â”‚ Filter:       â”‚
   â”‚             â”‚               â”‚              â”‚ same tour,    â”‚
   â”‚             â”‚               â”‚              â”‚ public, open  â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚  Departures   â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚  Departures  â”‚               â”‚
   â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 3. Display  â”‚               â”‚              â”‚               â”‚
   â”‚ dropdown    â”‚               â”‚              â”‚               â”‚
   â”‚ with optionsâ”‚               â”‚              â”‚               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 4. Select   â”‚               â”‚              â”‚               â”‚
   â”‚ departure   â”‚               â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 5. Click    â”‚               â”‚              â”‚               â”‚
   â”‚ Join Public â”‚               â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 6. Validate   â”‚              â”‚               â”‚
   â”‚             â”‚ capacity      â”‚              â”‚               â”‚
   â”‚             â”‚ (client)      â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 7. Show       â”‚              â”‚               â”‚
   â”‚             â”‚ confirmation  â”‚              â”‚               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 8. Confirm  â”‚               â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 9. STEP 1:    â”‚              â”‚               â”‚
   â”‚             â”‚ Convert type  â”‚              â”‚               â”‚
   â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚               â”‚
   â”‚             â”‚               â”‚ POST /convert-type           â”‚
   â”‚             â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ Update        â”‚
   â”‚             â”‚               â”‚              â”‚ booking.type  â”‚
   â”‚             â”‚               â”‚              â”‚ = 'public'    â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ Update        â”‚
   â”‚             â”‚               â”‚              â”‚ departure.typeâ”‚
   â”‚             â”‚               â”‚              â”‚ = 'public'    â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚  Success     â”‚               â”‚
   â”‚             â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 10. STEP 2:   â”‚              â”‚               â”‚
   â”‚             â”‚ Move booking  â”‚              â”‚               â”‚
   â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚               â”‚
   â”‚             â”‚               â”‚ POST /move   â”‚               â”‚
   â”‚             â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ Find/Create   â”‚
   â”‚             â”‚               â”‚              â”‚ target dep    â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ old.currentPaxâ”‚
   â”‚             â”‚               â”‚              â”‚ -= pax        â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ new.currentPaxâ”‚
   â”‚             â”‚               â”‚              â”‚ += pax        â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ Update bookingâ”‚
   â”‚             â”‚               â”‚              â”‚ references    â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ If old dep    â”‚
   â”‚             â”‚               â”‚              â”‚ empty â†’ deleteâ”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚  Success     â”‚               â”‚
   â”‚             â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ Success       â”‚              â”‚               â”‚
   â”‚             â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 11. Invalidate queries       â”‚               â”‚
   â”‚             â”‚ 12. Show toast               â”‚               â”‚
   â”‚             â”‚ 13. Close modal              â”‚               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
```

---

## âŒ CANCELLATION FLOW (with Ghost Cleanup)

```
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User â”‚    â”‚ Frontend â”‚    â”‚ Service â”‚    â”‚  Backend â”‚    â”‚   DB     â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 1. Change   â”‚               â”‚              â”‚               â”‚
   â”‚ status to   â”‚               â”‚              â”‚               â”‚
   â”‚ "cancelled" â”‚               â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 2. Show       â”‚              â”‚               â”‚
   â”‚             â”‚ warning       â”‚              â”‚               â”‚
   â”‚             â”‚ dialog        â”‚              â”‚               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ "âš ï¸ IRREVERSIBLE!"           â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ 3. Confirm  â”‚               â”‚              â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 4. Update     â”‚              â”‚               â”‚
   â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>              â”‚               â”‚
   â”‚             â”‚               â”‚ PUT /status  â”‚               â”‚
   â”‚             â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ 5. Check type â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ IF PRIVATE:   â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚ Set booking   â”‚
   â”‚             â”‚               â”‚              â”‚ status        â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚ Set departure â”‚
   â”‚             â”‚               â”‚              â”‚ status        â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ IF PUBLIC:    â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚ Set booking   â”‚
   â”‚             â”‚               â”‚              â”‚ status        â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚ currentPax    â”‚
   â”‚             â”‚               â”‚              â”‚ -= pax        â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ 6. Check      â”‚
   â”‚             â”‚               â”‚              â”‚ currentPax    â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚ IF === 0:     â”‚
   â”‚             â”‚               â”‚              â”‚ Ghost cleanup â”‚
   â”‚             â”‚               â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚             â”‚               â”‚              â”‚ Delete        â”‚
   â”‚             â”‚               â”‚              â”‚ departure     â”‚
   â”‚             â”‚               â”‚              â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚  Success     â”‚               â”‚
   â”‚             â”‚               â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚ 7. Invalidate â”‚              â”‚               â”‚
   â”‚             â”‚ 8. Update UI  â”‚              â”‚               â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
   â”‚ Status:     â”‚               â”‚              â”‚               â”‚
   â”‚ Cancelled   â”‚               â”‚              â”‚               â”‚
   â”‚ (IRREVERSIBLE)               â”‚              â”‚               â”‚
   â”‚             â”‚               â”‚              â”‚               â”‚
```

---

## ğŸ”„ DATA SYNC PATTERNS

### React Query Cache Invalidation

```
User Action â†’ Mutation â†’ onSuccess â†’ Invalidate Queries
                                    â†“
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  Query Invalidation â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                â”‚                â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
            â”‚  bookings    â”‚ â”‚ departures â”‚  â”‚   booking    â”‚
            â”‚  (all)       â”‚ â”‚  (all)     â”‚  â”‚    (:id)     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                â”‚                â”‚
                    â”‚   Auto Re-fetch (if mounted)    â”‚
                    â”‚                â”‚                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  UI Auto-Update â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Example: Create Booking Invalidation

```typescript
createBooking.mutate(payload, {
  onSuccess: () => {
    queryClient.invalidateQueries(['bookings']);        // All bookings
    queryClient.invalidateQueries(['departures']);      // All departures
    queryClient.invalidateQueries(['departure', depId]); // Specific departure
  }
});
```

**Result**:
- Bookings list re-fetches â†’ Shows new booking
- Departures list re-fetches â†’ Shows updated currentPax
- Departure detail re-fetches â†’ Shows new booking in list

---

## ğŸ“Š STATE FLOW DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application State                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Server State  â”‚             â”‚  Client State   â”‚
    â”‚ (React Query) â”‚             â”‚  (React State)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                               â”‚
           â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  - tours        â”‚           â”‚ - selectedId    â”‚
    â”‚  - departures   â”‚           â”‚ - modalOpen     â”‚
    â”‚  - bookings     â”‚           â”‚ - activeTab     â”‚
    â”‚                 â”‚           â”‚ - filters       â”‚
    â”‚  Cached (5 min) â”‚           â”‚                 â”‚
    â”‚  Auto-refetch   â”‚           â”‚  Component      â”‚
    â”‚  on mutation    â”‚           â”‚  scoped         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Global State    â”‚
    â”‚ (Context)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ - adminKey      â”‚
    â”‚ - isAuth        â”‚
    â”‚ - toasts        â”‚
    â”‚                 â”‚
    â”‚  Persisted      â”‚
    â”‚  (localStorage) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ COMPONENT COMMUNICATION

```
Parent Component
       â”‚
       â”œâ”€> State: selectedId
       â”‚
       â”œâ”€> Query: useBooking(selectedId)
       â”‚   â””â”€> Fetches from React Query cache/API
       â”‚
       â””â”€> Child Modal
           â”‚
           â”œâ”€> Props: { bookingId: selectedId, onClose }
           â”‚
           â”œâ”€> Mutation: updateBooking
           â”‚   â””â”€> executes onSuccess
           â”‚       â””â”€> invalidateQueries(['booking', selectedId])
           â”‚           â””â”€> Parent's query auto-refetches
           â”‚               â””â”€> Parent re-renders with new data
           â”‚
           â””â”€> Calls onClose()
               â””â”€> Parent sets selectedId = null
                   â””â”€> Modal closes
```

---

**Document**: System Flows & Diagrams  
**Version**: 1.0  
**Last Updated**: November 25, 2025
